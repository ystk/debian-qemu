From: Mauro Matteo Cascella <mcascell@redhat.com>
Date: Sat, 1 Aug 2020 16:42:38 +0000 (+0200)
Subject: hw/net/net_tx_pkt: fix assertion failure in net_tx_pkt_add_raw_fragment()
X-Git-Tag: v5.1.0-rc3~7^2
Origin: https://git.qemu.org/?p=qemu.git;a=commitdiff_plain;h=035e69b063835a5fd23cacabd63690a3d84532a8
Reviewed-by: Sylvain Beucler <beuc@debian.org>
Last-Update: 2020-09-12

hw/net/net_tx_pkt: fix assertion failure in net_tx_pkt_add_raw_fragment()

An assertion failure issue was found in the code that processes network packets
while adding data fragments into the packet context. It could be abused by a
malicious guest to abort the QEMU process on the host. This patch replaces the
affected assert() with a conditional statement, returning false if the current
data fragment exceeds max_raw_frags.

Reported-by: Alexander Bulekov <alxndr@bu.edu>
Reported-by: Ziming Zhang <ezrakiez@gmail.com>
Reviewed-by: Dmitry Fleytman <dmitry.fleytman@gmail.com>
Signed-off-by: Mauro Matteo Cascella <mcascell@redhat.com>
Signed-off-by: Jason Wang <jasowang@redhat.com>
---

Index: qemu-2.1+dfsg/hw/net/vmxnet_tx_pkt.c
===================================================================
--- qemu-2.1+dfsg.orig/hw/net/vmxnet_tx_pkt.c
+++ qemu-2.1+dfsg/hw/net/vmxnet_tx_pkt.c
@@ -347,7 +347,10 @@ bool vmxnet_tx_pkt_add_raw_fragment(stru
     hwaddr mapped_len = 0;
     struct iovec *ventry;
     assert(pkt);
-    assert(pkt->max_raw_frags > pkt->raw_frags);
+
+    if (pkt->raw_frags >= pkt->max_raw_frags) {
+        return false;
+    }
 
     if (!len) {
         return true;
