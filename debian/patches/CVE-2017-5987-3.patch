Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.33
Reviewed-by Santiago R.R. <santiagorr@riseup.net>
Bug-Debian: 855159

Backport of:

From 45ba9f761bde329cc5ef276b571bd4f3c41a044e Mon Sep 17 00:00:00 2001
From: Prasad J Pandit <pjp@fedoraproject.org>
Date: Tue, 28 Feb 2017 12:08:14 +0000
Subject: [PATCH] sd: sdhci: conditionally invoke multi block transfer

In sdhci_write invoke multi block transfer if it is enabled
in the transfer mode register 's->trnmod'.

Signed-off-by: Prasad J Pandit <pjp@fedoraproject.org>
Message-id: 20170214185225.7994-4-ppandit@redhat.com
Reviewed-by: Alistair Francis <alistair.francis@xilinx.com>
Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
---
 hw/sd/sdhci.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

Index: qemu-2.0.0+dfsg/hw/sd/sdhci.c
===================================================================
--- qemu-2.0.0+dfsg.orig/hw/sd/sdhci.c	2017-04-06 10:00:16.620440758 -0400
+++ qemu-2.0.0+dfsg/hw/sd/sdhci.c	2017-04-06 10:01:48.933597061 -0400
@@ -999,7 +999,11 @@
         /* Writing to last byte of sdmasysad might trigger transfer */
         if (!(mask & 0xFF000000) && TRANSFERRING_DATA(s->prnsts) && s->blkcnt &&
                 s->blksize && SDHC_DMA_TYPE(s->hostctl) == SDHC_CTRL_SDMA) {
-            SDHCI_GET_CLASS(s)->do_sdma_multi(s);
+            if (s->trnmod & SDHC_TRNS_MULTI) {
+                SDHCI_GET_CLASS(s)->do_sdma_multi(s);
+            } else {
+                SDHCI_GET_CLASS(s)->do_sdma_single(s);
+            }
         }
         break;
     case SDHC_BLKSIZE:
