From 0c0fc2b5fd534786051889459848764edd798050 Mon Sep 17 00:00:00 2001
From: Prasad J Pandit <pjp@fedoraproject.org>
Date: Thu, 20 Oct 2016 13:10:24 +0530
Subject: [PATCH] audio: intel-hda: check stream entry count during transfer

Intel HDA emulator uses stream of buffers during DMA data
transfers. Each entry has buffer length and buffer pointer
position, which are used to derive bytes to 'copy'. If this
length and buffer pointer were to be same, 'copy' could be
set to zero(0), leading to an infinite loop. Add check to
avoid it.

Reported-by: Huawei PSIRT <psirt@huawei.com>
Signed-off-by: Prasad J Pandit <pjp@fedoraproject.org>
Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
Message-id: 1476949224-6865-1-git-send-email-ppandit@redhat.com
Signed-off-by: Gerd Hoffmann <kraxel@redhat.com>

Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.43
Bug-Debian: https://bugs.debian.org/841950
Reviewed-by: Santiago R.R. <santiagorr@riseup.net>
---
 hw/audio/intel-hda.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

Index: qemu-2.0.0+dfsg/hw/audio/intel-hda.c
===================================================================
--- qemu-2.0.0+dfsg.orig/hw/audio/intel-hda.c	2016-11-07 15:45:42.767821196 -0500
+++ qemu-2.0.0+dfsg/hw/audio/intel-hda.c	2016-11-07 15:45:42.763821151 -0500
@@ -413,7 +413,8 @@
     }
 
     left = len;
-    while (left > 0) {
+    s = st->bentries;
+    while (left > 0 && s-- > 0) {
         copy = left;
         if (copy > st->bsize - st->lpib)
             copy = st->bsize - st->lpib;
