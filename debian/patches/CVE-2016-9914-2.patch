Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.33
Reviewed-by Santiago R.R. <santiagorr@riseup.net>
Bug-Debian: 847496

Backport of:

From f2b58c43758efc61e2a49b899f5e58848489d0dc Mon Sep 17 00:00:00 2001
From: Greg Kurz <groug@kaod.org>
Date: Tue, 3 Jan 2017 17:28:44 +0100
Subject: [PATCH] 9pfs: fix crash when fsdev is missing

If the user passes -device virtio-9p without the corresponding -fsdev, QEMU
dereferences a NULL pointer and crashes.

This is a 2.8 regression introduced by commit 702dbcc274e2c.

Signed-off-by: Greg Kurz <groug@kaod.org>
Reviewed-by: Li Qiang <liq3ea@gmail.com>
---
 hw/9pfs/9p.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: qemu/hw/9pfs/virtio-9p-device.c
===================================================================
--- qemu.orig/hw/9pfs/virtio-9p-device.c
+++ qemu/hw/9pfs/virtio-9p-device.c
@@ -131,7 +131,7 @@ static void virtio_9p_device_realize(Dev
 
     return;
 out:
-    if (s->ops->cleanup && s->ctx.private) {
+    if (s->ops && s->ops->cleanup && s->ctx.private) {
         s->ops->cleanup(&s->ctx);
     }
     g_free(s->ctx.fs_root);
