From: Markus Koschany <apo@debian.org>
Date: Sat, 27 Mar 2021 10:47:49 +0200
Subject: CVE-2021-20255

Bug-Debian: https://bugs.debian.org/984451
Origin: https://lists.gnu.org/archive/html/qemu-devel/2021-02/msg06098.html
---
 hw/net/eepro100.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/hw/net/eepro100.c b/hw/net/eepro100.c
index 2ecca4e..54e03b9 100644
--- a/hw/net/eepro100.c
+++ b/hw/net/eepro100.c
@@ -275,6 +275,9 @@ typedef struct {
     /* Quasi static device properties (no need to save them). */
     uint16_t stats_size;
     bool has_extended_tcb_support;
+
+    /* Flag to avoid recursions. */
+    bool busy;
 } EEPRO100State;
 
 /* Word indices in EEPROM. */
@@ -864,6 +867,14 @@ static void action_command(EEPRO100State *s)
        Therefore we limit the number of iterations. */
     unsigned max_loop_count = 16;
 
+    if (s->busy) {
+        /* Prevent recursions. */
+        logout("recursion in %s:%u\n", __FILE__, __LINE__);
+        return;
+    }
+
+    s->busy = true;
+
     for (;;) {
         bool bit_el;
         bool bit_s;
@@ -960,6 +971,7 @@ static void action_command(EEPRO100State *s)
     }
     TRACE(OTHER, logout("CU list empty\n"));
     /* List is empty. Now CU is idle or suspended. */
+    s->busy = false;
 }
 
 static void eepro100_cu_command(EEPRO100State * s, uint8_t val)
