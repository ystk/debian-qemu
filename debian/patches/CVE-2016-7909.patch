From 34e29ce754c02bb6b3bdd244fbb85033460feaff Mon Sep 17 00:00:00 2001
From: Prasad J Pandit <pjp@fedoraproject.org>
Date: Fri, 30 Sep 2016 00:27:33 +0530
Subject: [PATCH] net: pcnet: check rx/tx descriptor ring length

The AMD PC-Net II emulator has set of control and status(CSR)
registers. Of these, CSR76 and CSR78 hold receive and transmit
descriptor ring length respectively. This ring length could range
from 1 to 65535. Setting ring length to zero leads to an infinite
loop in pcnet_rdra_addr() or pcnet_transmit(). Add check to avoid it.

Reported-by: Li Qiang <liqiang6-s@360.cn>
Signed-off-by: Prasad J Pandit <pjp@fedoraproject.org>
Signed-off-by: Jason Wang <jasowang@redhat.com>

Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.43
Bug-Debian: https://bugs.debian.org/839834
Reviewed-by: Santiago R.R. <santiagorr@riseup.net>
---
 hw/net/pcnet.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

Index: qemu-2.0.0+dfsg/hw/net/pcnet.c
===================================================================
--- qemu-2.0.0+dfsg.orig/hw/net/pcnet.c	2016-11-07 15:42:37.653747208 -0500
+++ qemu-2.0.0+dfsg/hw/net/pcnet.c	2016-11-07 15:42:37.653747208 -0500
@@ -1451,8 +1451,11 @@
     case 47: /* POLLINT */
     case 72:
     case 74:
+        break;
     case 76: /* RCVRL */
     case 78: /* XMTRL */
+        val = (val > 0) ? val : 512;
+        break;
     case 112:
        if (CSR_STOP(s) || CSR_SPND(s))
            break;
