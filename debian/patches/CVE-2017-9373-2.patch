Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.35
Reviewed-by Santiago R.R. <santiagorr@riseup.net>
Bug-Debian: 864216

Backport of:

From d68f0f778e7f4fbd674627274267f269e40f0b04 Mon Sep 17 00:00:00 2001
From: Li Qiang <liq3ea@gmail.com>
Date: Wed, 15 Mar 2017 20:50:14 -0400
Subject: [PATCH] ide: ahci: call cleanup function in ahci unit

This can avoid memory leak when hotunplug the ahci device.

Signed-off-by: Li Qiang <liqiang6-s@360.cn>
Message-id: 1488449293-80280-4-git-send-email-liqiang6-s@360.cn
Signed-off-by: John Snow <jsnow@redhat.com>
---
 hw/ide/ahci.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

Index: qemu-2.0.0+dfsg/hw/ide/ahci.c
===================================================================
--- qemu-2.0.0+dfsg.orig/hw/ide/ahci.c	2017-08-22 10:20:33.300465533 -0400
+++ qemu-2.0.0+dfsg/hw/ide/ahci.c	2017-08-22 10:21:18.236467628 -0400
@@ -1211,6 +1211,18 @@ void ahci_init(AHCIState *s, DeviceState
 
 void ahci_uninit(AHCIState *s)
 {
+    int i, j;
+
+    for (i = 0; i < s->ports; i++) {
+        AHCIDevice *ad = &s->dev[i];
+
+        for (j = 0; j < 2; j++) {
+            IDEState *s = &ad->port.ifs[j];
+
+            ide_exit(s);
+        }
+    }
+
     memory_region_destroy(&s->mem);
     memory_region_destroy(&s->idp);
     g_free(s->dev);
