From a0d1cbdacff5df4ded16b753b38fdd9da6092968 Mon Sep 17 00:00:00 2001
From: chaojianhu <chaojianhu@hotmail.com>
Date: Tue, 9 Aug 2016 11:52:54 +0800
Subject: [PATCH] hw/net: Fix a heap overflow in xlnx.xps-ethernetlite

The .receive callback of xlnx.xps-ethernetlite doesn't check the length
of data before calling memcpy. As a result, the NetClientState object in
heap will be overflowed. All versions of qemu with xlnx.xps-ethernetlite
will be affected.

Reported-by: chaojianhu <chaojianhu@hotmail.com>
Signed-off-by: chaojianhu <chaojianhu@hotmail.com>
Signed-off-by: Jason Wang <jasowang@redhat.com>

Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.43
Bug-Debian: https://bugs.debian.org/838850
Reviewed-by: Santiago R.R. <santiagorr@riseup.net>
---
 hw/net/xilinx_ethlite.c |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

Index: qemu-2.0.0+dfsg/hw/net/xilinx_ethlite.c
===================================================================
--- qemu-2.0.0+dfsg.orig/hw/net/xilinx_ethlite.c	2016-11-07 15:32:47.023129879 -0500
+++ qemu-2.0.0+dfsg/hw/net/xilinx_ethlite.c	2016-11-07 15:32:47.019129834 -0500
@@ -193,6 +193,10 @@
     }
 
     D(qemu_log("%s %zd rxbase=%x\n", __func__, size, rxbase));
+    if (size > (R_MAX - R_RX_BUF0 - rxbase) * 4) {
+        D(qemu_log("ethlite packet is too big, size=%x\n", size));
+        return -1;
+    }
     memcpy(&s->regs[rxbase + R_RX_BUF0], buf, size);
 
     s->regs[rxbase + R_RX_CTRL0] |= CTRL_S;
