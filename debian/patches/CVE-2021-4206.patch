
CVE-2021-4206

--- qemu-3.1+dfsg.orig/hw/display/qxl-render.c
+++ qemu-3.1+dfsg/hw/display/qxl-render.c
@@ -240,6 +240,13 @@ static QEMUCursor *qxl_cursor(PCIQXLDevi
     size_t size;
 
     c = cursor_alloc(cursor->header.width, cursor->header.height);
+
+    if (!c) {
+        qxl_set_guest_bug(qxl, "%s: cursor %ux%u alloc error", __func__,
+                cursor->header.width, cursor->header.height);
+        goto fail;
+    }
+
     c->hot_x = cursor->header.hot_spot_x;
     c->hot_y = cursor->header.hot_spot_y;
     switch (cursor->header.type) {
--- qemu-3.1+dfsg.orig/hw/display/vmware_vga.c
+++ qemu-3.1+dfsg/hw/display/vmware_vga.c
@@ -505,6 +505,7 @@ static inline void vmsvga_cursor_define(
     int i, pixels;
 
     qc = cursor_alloc(c->width, c->height);
+    assert(qc != NULL);
     qc->hot_x = c->hot_x;
     qc->hot_y = c->hot_y;
     switch (c->bpp) {
--- qemu-3.1+dfsg.orig/ui/cursor.c
+++ qemu-3.1+dfsg/ui/cursor.c
@@ -47,6 +47,8 @@ static QEMUCursor *cursor_parse_xpm(cons
 
     /* parse pixel data */
     c = cursor_alloc(width, height);
+    assert(c != NULL);
+
     for (pixel = 0, y = 0; y < height; y++, line++) {
         for (x = 0; x < height; x++, pixel++) {
             idx = xpm[line][x];
@@ -92,7 +94,11 @@ QEMUCursor *cursor_builtin_left_ptr(void
 QEMUCursor *cursor_alloc(int width, int height)
 {
     QEMUCursor *c;
-    int datasize = width * height * sizeof(uint32_t);
+    size_t datasize = width * height * sizeof(uint32_t);
+
+    if (width > 512 || height > 512) {
+        return NULL;
+    }
 
     c = g_malloc0(sizeof(QEMUCursor) + datasize);
     c->width  = width;
