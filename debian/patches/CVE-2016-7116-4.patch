Backport of:

From 5e2c6fe7cc5314c13d96069328b603c40dc12b41 Mon Sep 17 00:00:00 2001
From: Greg Kurz <groug@kaod.org>
Date: Fri, 16 Sep 2016 11:44:49 +0200
Subject: [PATCH] 9pfs: fix potential segfault during walk
MIME-Version: 1.0
Content-Type: text/plain; charset=utf8
Content-Transfer-Encoding: 8bit

If the call to fid_to_qid() returns an error, we will call v9fs_path_free()
on uninitialized paths.

It is a regression introduced by the following commit:

56f101ecce0e 9pfs: handle walk of ".." in the root directory

Let's fix this by initializing dpath and path before calling fid_to_qid().

Signed-off-by: Greg Kurz <groug@kaod.org>
Reviewed-by: CÃ©dric Le Goater <clg@kaod.org>
[groug: updated the changelog to indicate this is regression and to provide
        the offending commit SHA1]
Signed-off-by: Greg Kurz <groug@kaod.org>

(cherry picked from commit 13fd08e631ec0c3ff5ad1bdcb6a4474c7d9a024f)
Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>

Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.43
Bug-Debian: https://bugs.debian.org/836502
Reviewed-by: Santiago R.R. <santiagorr@riseup.net>
---
 hw/9pfs/9p.c |    5 +++--
 1 files changed, 3 insertions(+), 2 deletions(-)

Index: qemu-2.0.0+dfsg/hw/9pfs/virtio-9p.c
===================================================================
--- qemu-2.0.0+dfsg.orig/hw/9pfs/virtio-9p.c	2016-11-07 15:32:22.422854261 -0500
+++ qemu-2.0.0+dfsg/hw/9pfs/virtio-9p.c	2016-11-07 15:32:22.418854216 -0500
@@ -1290,13 +1290,14 @@
         goto out_nofid;
     }
 
+    v9fs_path_init(&dpath);
+    v9fs_path_init(&path);
+
     err = fid_to_qid(pdu, fidp, &qid);
     if (err < 0) {
         goto out;
     }
 
-    v9fs_path_init(&dpath);
-    v9fs_path_init(&path);
     /*
      * Both dpath and path initially poin to fidp.
      * Needed to handle request with nwnames == 0
