From: Max Reitz <mreitz@redhat.com>
Date: Sun, 11 Jun 2017 14:37:14 +0200
Subject: CVE-2017-10664: Ignore SIGPIPE

qemu proper has done so for 13 years
(8a7ddc38a60648257dc0645ab4a05b33d6040063), qemu-img and qemu-io have
done so for four years (526eda14a68d5b3596be715505289b541288ef2a).
Ignoring this signal is especially important in qemu-nbd because
otherwise a client can easily take down the qemu-nbd server by dropping
the connection when the server wants to send something, for example:

$ qemu-nbd -x foo -f raw -t null-co:// &
[1] 12726
$ qemu-io -c quit nbd://localhost/bar
can't open device nbd://localhost/bar: No export with name 'bar' available
[1]  + 12726 broken pipe  qemu-nbd -x foo -f raw -t null-co://

In this case, the client sends an NBD_OPT_ABORT and closes the
connection (because it is not required to wait for a reply), but the
server replies with an NBD_REP_ACK (because it is required to reply).

This upstream commit 041e32b8d9d076980b4e35317c0339e57ab888f1

Origin: debian, 1.1.2+dfsg-6+deb7u23
Reviewed-by Santiago R.R. <santiagorr@riseup.net>
Bug-Debian: https://bugs.debian.org/866674
---
 qemu-nbd.c | 4 ++++
 1 file changed, 4 insertions(+)

Index: qemu/qemu-nbd.c
===================================================================
--- qemu.orig/qemu-nbd.c
+++ qemu/qemu-nbd.c
@@ -442,6 +442,10 @@ int main(int argc, char **argv)
     sigaction(SIGTERM, &sa_sigterm, NULL);
     qemu_init_exec_dir(argv[0]);
 
+#ifdef CONFIG_POSIX
+    signal(SIGPIPE, SIG_IGN);
+#endif
+
     while ((ch = getopt_long(argc, argv, sopt, lopt, &opt_ind)) != -1) {
         switch (ch) {
         case 's':
