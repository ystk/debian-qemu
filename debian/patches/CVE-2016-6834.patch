From 3b9717a62bf5882abaf6602c077cdbe63dffc35e Mon Sep 17 00:00:00 2001
From: Prasad J Pandit <pjp@fedoraproject.org>
Date: Thu, 4 Aug 2016 13:00:14 +0530
Subject: [PATCH] net: check fragment length during fragmentation

Network transport abstraction layer supports packet fragmentation.
While fragmenting a packet, it checks for more fragments from
packet length and current fragment length. It is susceptible
to an infinite loop, if the current fragment length is zero.
Add check to avoid it.

Reported-by: Li Qiang <liqiang6-s@360.cn>
Signed-off-by: Prasad J Pandit <pjp@fedoraproject.org>
Reviewed-by: Dmitry Fleytman <dmitry@daynix.com>
CC: qemu-stable@nongnu.org
Signed-off-by: Jason Wang <jasowang@redhat.com>
(cherry picked from commit ead315e43ea0c2ca3491209c6c8db8ce3f2bbe05)
Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>

Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.43
Bug-Debian: https://bugs.debian.org/834905
Reviewed-by: Santiago R.R. <santiagorr@riseup.net>
---
 hw/net/vmxnet_tx_pkt.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

Index: qemu-2.5+dfsg/hw/net/vmxnet_tx_pkt.c
===================================================================
--- qemu-2.5+dfsg.orig/hw/net/vmxnet_tx_pkt.c	2016-11-07 10:54:23.347984625 -0500
+++ qemu-2.5+dfsg/hw/net/vmxnet_tx_pkt.c	2016-11-07 10:54:23.347984625 -0500
@@ -543,7 +543,7 @@
 
         fragment_offset += fragment_len;
 
-    } while (more_frags);
+    } while (fragment_len && more_frags);
 
     return true;
 }
