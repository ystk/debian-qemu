From c7c35916692fe010fef25ac338443d3fe40be225 Mon Sep 17 00:00:00 2001
From: Prasad J Pandit <pjp@fedoraproject.org>
Date: Fri, 21 Oct 2016 17:39:29 +0530
Subject: [PATCH] net: rtl8139: limit processing of ring descriptors

RTL8139 ethernet controller in C+ mode supports multiple
descriptor rings, each with maximum of 64 descriptors. While
processing transmit descriptor ring in 'rtl8139_cplus_transmit',
it does not limit the descriptor count and runs forever. Add
check to avoid it.

Reported-by: Andrew Henderson <hendersa@icculus.org>
Signed-off-by: Prasad J Pandit <pjp@fedoraproject.org>
Signed-off-by: Jason Wang <jasowang@redhat.com>

Origin: ubuntu,
https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.43
Bug-Debian: https://bugs.debian.org/841955
Reviewed-by: Santiago R.R. <santiagorr@riseup.net>
---
 hw/net/rtl8139.c |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

Index: qemu-2.0.0+dfsg/hw/net/rtl8139.c
===================================================================
--- qemu-2.0.0+dfsg.orig/hw/net/rtl8139.c	2016-11-07 15:45:51.123914816 -0500
+++ qemu-2.0.0+dfsg/hw/net/rtl8139.c	2016-11-07 15:45:51.119914771 -0500
@@ -2432,7 +2432,7 @@
 {
     int txcount = 0;
 
-    while (rtl8139_cplus_transmit_one(s))
+    while (txcount < 64 && rtl8139_cplus_transmit_one(s))
     {
         ++txcount;
     }
