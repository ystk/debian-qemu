Backport of:

From ba42ebb863ab7d40adc79298422ed9596df8f73a Mon Sep 17 00:00:00 2001
From: Li Qiang <liqiang6-s@360.cn>
Date: Mon, 17 Oct 2016 14:13:58 +0200
Subject: [PATCH] 9pfs: allocate space for guest originated empty strings

If a guest sends an empty string paramater to any 9P operation, the current
code unmarshals it into a V9fsString equal to { .size = 0, .data = NULL }.

This is unfortunate because it can cause NULL pointer dereference to happen
at various locations in the 9pfs code. And we don't want to check str->data
everywhere we pass it to strcmp() or any other function which expects a
dereferenceable pointer.

This patch enforces the allocation of genuine C empty strings instead, so
callers don't have to bother.

Out of all v9fs_iov_vunmarshal() users, only v9fs_xattrwalk() checks if
the returned string is empty. It now uses v9fs_string_size() since
name.data cannot be NULL anymore.

Signed-off-by: Li Qiang <liqiang6-s@360.cn>
[groug, rewritten title and changelog,
 fix empty string check in v9fs_xattrwalk()]
Signed-off-by: Greg Kurz <groug@kaod.org>

Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.43
Bug-Debian: https://bugs.debian.org/840340
Reviewed-by: Santiago R.R. <santiagorr@riseup.net>
---
 fsdev/9p-iov-marshal.c |    2 +-
 hw/9pfs/9p.c           |    2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

Index: qemu-2.0.0+dfsg/fsdev/virtio-9p-marshal.c
===================================================================
--- qemu-2.0.0+dfsg.orig/fsdev/virtio-9p-marshal.c	2016-11-07 15:44:27.842981751 -0500
+++ qemu-2.0.0+dfsg/fsdev/virtio-9p-marshal.c	2016-11-07 15:44:27.838981705 -0500
@@ -166,7 +166,7 @@
                 str->data = g_malloc(str->size + 1);
                 copied = v9fs_unpack(str->data, out_sg, out_num, offset,
                                      str->size);
-                if (copied > 0) {
+                if (copied >= 0) {
                     str->data[str->size] = 0;
                 } else {
                     v9fs_string_free(str);
Index: qemu-2.0.0+dfsg/hw/9pfs/virtio-9p.c
===================================================================
--- qemu-2.0.0+dfsg.orig/hw/9pfs/virtio-9p.c	2016-11-07 15:44:27.842981751 -0500
+++ qemu-2.0.0+dfsg/hw/9pfs/virtio-9p.c	2016-11-07 15:44:27.838981705 -0500
@@ -3132,7 +3132,7 @@
         goto out;
     }
     v9fs_path_copy(&xattr_fidp->path, &file_fidp->path);
-    if (name.data == NULL) {
+    if (!v9fs_string_size(&name)) {
         /*
          * listxattr request. Get the size first
          */
