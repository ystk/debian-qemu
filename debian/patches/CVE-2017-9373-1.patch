Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.35
Reviewed-by Santiago R.R. <santiagorr@riseup.net>
Bug-Debian: 864216

Backport of:

From c9f086418a255f386e1c4d2c1418c032eb349537 Mon Sep 17 00:00:00 2001
From: Li Qiang <liq3ea@gmail.com>
Date: Wed, 15 Mar 2017 20:50:14 -0400
Subject: [PATCH] ide: core: add cleanup function

As the pci ahci can be hotplug and unplug, in the ahci unrealize
function it should free all the resource once allocated in the
realized function. This patch add ide_exit to free the resource.

Signed-off-by: Li Qiang <liqiang6-s@360.cn>
Message-id: 1488449293-80280-3-git-send-email-liqiang6-s@360.cn
Signed-off-by: John Snow <jsnow@redhat.com>
---
 hw/ide/core.c             | 8 ++++++++
 include/hw/ide/internal.h | 1 +
 2 files changed, 9 insertions(+)

Index: qemu-2.0.0+dfsg/hw/ide/core.c
===================================================================
--- qemu-2.0.0+dfsg.orig/hw/ide/core.c	2017-08-22 10:19:58.548463912 -0400
+++ qemu-2.0.0+dfsg/hw/ide/core.c	2017-08-22 10:19:58.528463911 -0400
@@ -2246,6 +2246,14 @@ void ide_init2(IDEBus *bus, qemu_irq irq
     bus->dma = &ide_dma_nop;
 }
 
+void ide_exit(IDEState *s)
+{
+    timer_del(s->sector_write_timer);
+    timer_free(s->sector_write_timer);
+    qemu_vfree(s->smart_selftest_data);
+    qemu_vfree(s->io_buffer);
+}
+
 static const MemoryRegionPortio ide_portio_list[] = {
     { 0, 8, 1, .read = ide_ioport_read, .write = ide_ioport_write },
     { 0, 2, 2, .read = ide_data_readw, .write = ide_data_writew },
Index: qemu-2.0.0+dfsg/hw/ide/internal.h
===================================================================
--- qemu-2.0.0+dfsg.orig/hw/ide/internal.h	2017-08-22 10:19:58.548463912 -0400
+++ qemu-2.0.0+dfsg/hw/ide/internal.h	2017-08-22 10:19:58.532463911 -0400
@@ -554,6 +554,7 @@ int ide_init_drive(IDEState *s, BlockDri
                    uint32_t cylinders, uint32_t heads, uint32_t secs,
                    int chs_trans);
 void ide_init2(IDEBus *bus, qemu_irq irq);
+void ide_exit(IDEState *s);
 void ide_init_ioport(IDEBus *bus, ISADevice *isa, int iobase, int iobase2);
 
 void ide_exec_cmd(IDEBus *bus, uint32_t val);
