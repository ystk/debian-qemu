Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.33
Reviewed-by Santiago R.R. <santiagorr@riseup.net>
Bug-Debian: 853006
Backport of:

From b003fc0d8aa5e7060dbf7e5862b8013c73857c7f Mon Sep 17 00:00:00 2001
From: Greg Kurz <groug@kaod.org>
Date: Mon, 6 Mar 2017 17:34:01 +0100
Subject: [PATCH] 9pfs: fix vulnerability in openat_dir() and
 local_unlinkat_common()

We should pass O_NOFOLLOW otherwise openat() will follow symlinks and make
QEMU vulnerable.

While here, we also fix local_unlinkat_common() to use openat_dir() for
the same reasons (it was a leftover in the original patchset actually).

This fixes CVE-2016-9602.

Signed-off-by: Greg Kurz <groug@kaod.org>
Reviewed-by: Daniel P. Berrange <berrange@redhat.com>
Reviewed-by: Eric Blake <eblake@redhat.com>
---
 hw/9pfs/9p-local.c | 2 +-
 hw/9pfs/9p-util.h  | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

Index: qemu-2.5+dfsg/hw/9pfs/virtio-9p-local.c
===================================================================
--- qemu-2.5+dfsg.orig/hw/9pfs/virtio-9p-local.c	2017-04-04 14:05:54.056515474 -0400
+++ qemu-2.5+dfsg/hw/9pfs/virtio-9p-local.c	2017-04-04 14:05:54.052515422 -0400
@@ -956,7 +956,7 @@
         if (flags == AT_REMOVEDIR) {
             int fd;
 
-            fd = openat(dirfd, name, O_RDONLY | O_DIRECTORY | O_PATH);
+            fd = openat_dir(dirfd, name);
             if (fd == -1) {
                 goto err_out;
             }
Index: qemu-2.5+dfsg/hw/9pfs/virtio-9p-util.h
===================================================================
--- qemu-2.5+dfsg.orig/hw/9pfs/virtio-9p-util.h	2017-04-04 14:05:54.056515474 -0400
+++ qemu-2.5+dfsg/hw/9pfs/virtio-9p-util.h	2017-04-04 14:05:54.056515474 -0400
@@ -22,7 +22,7 @@
 
 static inline int openat_dir(int dirfd, const char *name)
 {
-    return openat(dirfd, name, O_DIRECTORY | O_RDONLY | O_PATH);
+    return openat(dirfd, name, O_DIRECTORY | O_RDONLY | O_NOFOLLOW | O_PATH);
 }
 
 static inline int openat_file(int dirfd, const char *name, int flags,
