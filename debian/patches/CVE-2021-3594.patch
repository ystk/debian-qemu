From: Markus Koschany <apo@debian.org>
Date: Wed, 25 Aug 2021 19:39:49 +0200
Subject: CVE-2021-3594

Bug-Debian: https://bugs.debian.org/989995
Origin: https://gitlab.freedesktop.org/slirp/libslirp/-/commit/93e645e72a056ec0b2c16e0299fc5c6b94e4ca17
Origin: https://gitlab.freedesktop.org/slirp/libslirp/-/commit/74572be49247c8c5feae7c6e0b50c4f569ca9824
---
 slirp/mbuf.c | 11 +++++++++++
 slirp/mbuf.h |  1 +
 slirp/udp.c  |  5 ++++-
 3 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/slirp/mbuf.c b/slirp/mbuf.c
index a4d108f..dcac128 100644
--- a/slirp/mbuf.c
+++ b/slirp/mbuf.c
@@ -238,3 +238,14 @@ dtom(Slirp *slirp, void *dat)
 
 	return (struct mbuf *)0;
 }
+
+void *mtod_check(struct mbuf *m, size_t len)
+{
+    if (m->m_len >= len) {
+        return m->m_data;
+    }
+
+    DEBUG_ERROR("mtod failed");
+
+    return NULL;
+}
diff --git a/slirp/mbuf.h b/slirp/mbuf.h
index 32e5120..d459b95 100644
--- a/slirp/mbuf.h
+++ b/slirp/mbuf.h
@@ -107,6 +107,7 @@ void m_inc(struct mbuf *, int);
 void m_adj(struct mbuf *, int);
 int m_copy(struct mbuf *, struct mbuf *, int, int);
 struct mbuf * dtom(Slirp *, void *);
+void *mtod_check(struct mbuf *, size_t len);
 
 static inline void ifs_init(struct mbuf *ifm)
 {
diff --git a/slirp/udp.c b/slirp/udp.c
index f77e00f..744199d 100644
--- a/slirp/udp.c
+++ b/slirp/udp.c
@@ -89,7 +89,10 @@ udp_input(register struct mbuf *m, int iphlen)
 	/*
 	 * Get IP and UDP header together in first mbuf.
 	 */
-	ip = mtod(m, struct ip *);
+	ip = mtod_check(m, iphlen + sizeof(struct udphdr));
+	if (ip == NULL) {
+		goto bad;
+	}
 	uh = (struct udphdr *)((caddr_t)ip + iphlen);
 
 	/*
