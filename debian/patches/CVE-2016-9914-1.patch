Origin: ubuntu, https://launchpad.net/ubuntu/+source/qemu/2.0.0+dfsg-2ubuntu1.33
Reviewed-by Santiago R.R. <santiagorr@riseup.net>
Bug-Debian: 847496

Index: qemu/fsdev/file-op-9p.h
===================================================================
--- qemu.orig/fsdev/file-op-9p.h
+++ qemu/fsdev/file-op-9p.h
@@ -102,6 +102,7 @@ struct FileOperations
 {
     int (*parse_opts)(QemuOpts *, struct FsDriverEntry *);
     int (*init)(struct FsContext *);
+    void (*cleanup)(struct FsContext *);
     int (*lstat)(FsContext *, V9fsPath *, struct stat *);
     ssize_t (*readlink)(FsContext *, V9fsPath *, char *, size_t);
     int (*chmod)(FsContext *, V9fsPath *, FsCred *);
Index: qemu/hw/9pfs/virtio-9p-device.c
===================================================================
--- qemu.orig/hw/9pfs/virtio-9p-device.c
+++ qemu/hw/9pfs/virtio-9p-device.c
@@ -131,6 +131,9 @@ static void virtio_9p_device_realize(Dev
 
     return;
 out:
+    if (s->ops->cleanup && s->ctx.private) {
+        s->ops->cleanup(&s->ctx);
+    }
     g_free(s->ctx.fs_root);
     g_free(s->tag);
     virtio_cleanup(vdev);
